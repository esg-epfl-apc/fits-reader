!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.FITSLibrary=e():t.FITSLibrary=e()}(self,(()=>(()=>{"use strict";var t,e={d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},r={};e.r(r),e.d(r,{default:()=>d});class s{constructor(t,e){e instanceof ArrayBuffer?this.buffer=e:this.blob=e}}class i extends s{maxMemory=1048576;constructor(t,e){super(t,e),this.rowByteSize=t.get("NAXIS1"),this.rows=t.get("NAXIS2"),this.cols=t.get("TFIELDS"),this.length=this.rowByteSize*this.rows,this.heapLength=t.get("PCOUNT"),this.columns=this.getColumns(t),null!=this.buffer?(this.rowsInMemory=this._rowsInMemoryBuffer,this.heap=this.buffer.slice(this.length,this.length+this.heapLength)):(this.rowsInMemory=this._rowsInMemoryBlob,this.firstRowInBuffer=this.lastRowInBuffer=0,this.nRowsInBuffer=Math.floor(this.maxMemory/this.rowByteSize)),this.accessors=[],this.descriptors=[],this.elementByteLengths=[],this.setAccessors(t)}_rowsInMemoryBuffer(){return!0}_rowsInMemoryBlob(t,e){return!(t<this.firstRowInBuffer||e>this.lastRowInBuffer)}getColumns(t){let e,r,s,i,n;for(e=[],r=s=1,n=this.cols;1<=n?s<=n:s>=n;r=1<=n?++s:--s){if(i=`TTYPE${r}`,!t.contains(i))return null;e.push(t.get(i))}return e}getColumn(t,e,r){let s,i,n,a,h,o,l,u,f,c,d;return null!=this.blob?(f=this.columns.indexOf(t),a=this.descriptors[f],s=this.accessors[f],h=this.elementByteLengths[f],o=this.elementByteLengths.slice(0,f),o=0===o.length?0:o.reduce((function(t,e){return t+e})),n=null!=this.typedArray[a]?new this.typedArray[a](this.rows):[],d=~~(this.maxMemory/this.rowByteSize),d=Math.min(d,this.rows),l=this.rows/d,c=Math.floor(l)===l?l:Math.floor(l)+1,u=0,f=0,i=(t,r)=>{let a,h,l,g;for(a=t.byteLength/this.rowByteSize,g=new DataView(t),h=o;a--;)n[u]=s(g,h)[0],u+=1,h+=this.rowByteSize;if(c-=1,f+=1,c)return l=f*d,this.getTableBuffer(l,d,i,r);this.invoke(e,r,n)},this.getTableBuffer(0,d,i,r)):(i=(r,s)=>(n=r.map((function(e){return e[t]})),this.invoke(e,s,n)),this.getRows(0,this.rows,i,r))}getTableBuffer(t,e,r,s){let i,n,a,h;return e=Math.min(this.rows-t,e),i=t*this.rowByteSize,a=i+e*this.rowByteSize,n=this.blob.slice(i,a),h=new FileReader,h.row=t,h.number=e,h.onloadend=t=>this.invoke(r,s,t.target.result),h.readAsArrayBuffer(n)}getRows(t,e,r,s){let i,n,a,h,o,l;return this.rowsInMemory(t,t+e)?(null!=this.blob?a=this.buffer:(i=t*this.rowByteSize,h=i+e*this.rowByteSize,a=this.buffer.slice(i,h)),l=this._getRows(a,e),this.invoke(r,s,l),l):(i=t*this.rowByteSize,h=i+Math.max(this.nRowsInBuffer*this.rowByteSize,e*this.rowByteSize),n=this.blob.slice(i,h),o=new FileReader,o.row=t,o.number=e,o.onloadend=i=>{let n;return n=i.target,this.buffer=n.result,this.firstRowInBuffer=this.lastRowInBuffer=n.row,this.lastRowInBuffer+=n.number,this.getRows(t,e,r,s)},o.readAsArrayBuffer(n))}}class n extends i{typedArray={B:Uint8Array,I:Uint16Array,J:Uint32Array,E:Float32Array,D:Float64Array,1:Uint8Array,2:Uint16Array,4:Uint32Array};static offsets={L:1,B:1,I:2,J:4,K:8,A:1,E:4,D:8,C:8,M:16};dataAccessors={L:function(t,e){let r,s;return s=t.getInt8(e),r=84===s,[r,e+=1]},B:function(t,e){let r;return r=t.getUint8(e),[r,e+=1]},I:function(t,e){let r;return r=t.getInt16(e),[r,e+=2]},J:function(t,e){let r;return r=t.getInt32(e),[r,e+=4]},K:function(t,e){let r,s,i,n,a;return s=Math.abs(t.getInt32(e)),e+=4,i=Math.abs(t.getInt32(e)),n=s%10,r=n?-1:1,s-=n,a=r*(s<<32|i),[a,e+=4]},A:function(t,e){let r;return r=t.getUint8(e),r=String.fromCharCode(r),[r,e+=1]},E:function(t,e){let r;return r=t.getFloat32(e),[r,e+=4]},D:function(t,e){let r;return r=t.getFloat64(e),[r,e+=8]},C:function(t,e){let r,s,i;return s=t.getFloat32(e),e+=4,i=t.getFloat32(e),r=[s,i],[r,e+=4]},M:function(t,e){let r,s,i;return s=t.getFloat64(e),e+=8,i=t.getFloat64(e),r=[s,i],[r,e+=8]}};toBits(t){let e,r;for(e=[],r=128;r>=1;)e.push(t&r?1:0),r/=2;return e}getFromHeap(t,e,r){let s,i,n,a,h;for(h=t.getInt32(e),e+=4,i=t.getInt32(e),e+=4,n=this.heap.slice(i,i+h),s=new this.typedArray[r](n),a=s.length;a--;)s[a]=this.constructor.swapEndian[r](s[a]);return[s,e]}setAccessors(t){let e,r,s,i,a,h,o,l,u,f,c;for(l=/(\d*)([P|Q]*)([L|X|B|I|J|K|A|E|D|C|M]{1})/,f=[],i=h=1,u=this.cols;1<=u?h<=u:h>=u;i=1<=u?++h:--h)s=t.get(`TFORM${i}`),c=t.get(`TTYPE${i}`),o=l.exec(s),e=parseInt(o[1])||1,a=o[2],r=o[3],f.push(((t,e)=>{let r,s;if(this.descriptors.push(t),this.elementByteLengths.push(n.offsets[t]*e),a)switch(c){case"COMPRESSED_DATA":r=(e,r)=>{let s,i;return[s,r]=this.getFromHeap(e,r,t),i=new this.typedArray[this.algorithmParameters.BYTEPIX](this.ztile[0]),Decompress.Rice(s,this.algorithmParameters.BLOCKSIZE,this.algorithmParameters.BYTEPIX,i,this.ztile[0],Decompress.RiceSetup),[i,r]};break;case"GZIP_COMPRESSED_DATA":r=(t,e)=>{let r;for(r=new Float32Array(this.width),i=r.length;i--;)r[i]=NaN;return[r,e]};break;default:r=(e,r)=>this.getFromHeap(e,r,t)}else 1===e?r=(e,r)=>{let s;return[s,r]=this.dataAccessors[t](e,r),[s,r]}:"X"===t?(s=Math.log(e)/Math.log(2),r=(t,r)=>{let i,n,a,h,o,l,u;for(a=t.buffer.slice(r,r+s),o=new Uint8Array(a),n=[],u=0,l=o.length;u<l;u++)h=o[u],i=this.toBits(h),n=n.concat(i);return r+=s,[n.slice(0,+(e-1)+1||9e9),r]}):r="A"===t?(t,r)=>{let s,i,n,a,h,o;for(i=t.buffer.slice(r,r+e),s=new Uint8Array(i),h="",a=0,n=s.length;a<n;a++)o=s[a],h+=String.fromCharCode(o);return h=h.trim(),[h,r+=e]}:(r,s)=>{let n,a;for(i=e,n=[];i--;)[a,s]=this.dataAccessors[t](r,s),n.push(a);return[n,s]};return this.accessors.push(r)})(r,e));return f}_getRows(t,e){let r,s,i,n,a,h,o,l,u,f;for(f=new DataView(t),a=0,l=[];e--;){for(o={},h=this.accessors,s=i=0,n=h.length;i<n;s=++i)r=h[s],[u,a]=r(f,a),o[this.columns[s]]=u;l.push(o)}return l}}class a{constructor(){this.cardIndex=0,this.primary=!1,this.extension=!1,this.extensionType=null}verifyOrder(t,e){e!==this.cardIndex&&console.warn(`${t} should appear at index ${this.cardIndex} in the FITS header`)}verifyBetween(t,e,r,s){if(!(e>=r&&e<=s))throw`The ${t} value of ${e} is not between ${r} and ${s}`}verifyBoolean(t){return"T"===t}SIMPLE(t){return this.primary=!0,this.verifyOrder("SIMPLE",0),this.verifyBoolean(t)}XTENSION(t){return this.extension=!0,this.extensionType=t,this.verifyOrder("XTENSION",0),this.extensionType}BITPIX(t){const e="BITPIX";if(t=parseInt(t),this.verifyOrder(e,1),![8,16,32,-32,-64].includes(t))throw`${e} value ${t} is not permitted`;return t}NAXIS(t,e){const r="NAXIS";return t=parseInt(t),e||(this.verifyOrder(r,2),this.verifyBetween(r,t,0,999)),t}PCOUNT(t){t=parseInt(t);const e=3+this.NAXIS();return this.verifyOrder("PCOUNT",e),t}GCOUNT(t){t=parseInt(t);const e=3+this.NAXIS()+1;return this.verifyOrder("GCOUNT",e),t}EXTEND(t){return this.verifyBoolean(t)}BSCALE(t){return parseFloat(t)}BZERO(t){return parseFloat(t)}BLANK(t){return t=parseInt(t),this.get("BITPIX")>0||console.warn(`BLANK is not to be used for BITPIX = ${this.get("BITPIX")}`),t}DATAMIN(t){return parseFloat(t)}DATAMAX(t){return parseFloat(t)}EXTVER(t){return parseInt(t)}EXTLEVEL(t){return parseInt(t)}TFIELDS(t){return t=parseInt(t),this.verifyBetween("TFIELDS",t,0,999),t}TBCOL(t,e){return t=parseInt(t),this.verifyBetween("TBCOL",e,0,this.get("TFIELDS")),t}ZIMAGE(t){return this.verifyBoolean(t)}ZCMPTYPE(t){if(!["GZIP_1","RICE_1","PLIO_1","HCOMPRESS_1"].includes(t))throw`ZCMPTYPE value ${t} is not permitted`;if("RICE_1"!==t)throw`Compress type ${t} is not yet implement`;return t}ZBITPIX(t){if(t=parseInt(t),![8,16,32,64,-32,-64].includes(t))throw`ZBITPIX value ${t} is not permitted`;return t}ZNAXIS(t,e){return t=parseInt(t),e||this.verifyBetween("ZNAXIS",t,0,999),t}ZTILE(t){return parseInt(t)}ZSIMPLE(t){return"T"===t}ZPCOUNT(t){return parseInt(t)}ZGCOUNT(t){return parseInt(t)}ZDITHER0(t){return parseInt(t)}}class h{arrayPattern=/(\D+)(\d+)/;maxLines=600;constructor(t,e=null){if(this.headerVerify=e,this.supportedCards=null,this.primary=!1,this.extension=!1,null!=e){const t=Object.getOwnPropertyNames(Object.getPrototypeOf(e));this.supportedCards=t.filter((t=>"function"==typeof e[t]))}this.cards={},this.cards.COMMENT=[],this.cards.HISTORY=[],this.cardIndex=0,this.block=t,this.readBlock(t)}get(t){return this.contains(t)?this.cards[t].value:null}set(t,e,r){return r=r||"",this.cards[t]={index:this.cardIndex,value:e,comment:r},this.cardIndex+=1}contains(t){return this.cards.hasOwnProperty(t)}readLine(t){let e,r,s,i,n,a;if(n=t.slice(0,8).trim(),e=""===n,!e){if(i=t.slice(8,10),a=t.slice(10),"= "===i)return[a,r]=a.split(" /"),a=a.trim(),s=a[0],"'"===s?a=a.slice(1,-1).trim():"T"!==a&&"F"!==a&&(a=parseFloat(a)),this.set(n,a,r);"COMMENT"!==n&&"HISTORY"!==n||this.cards[n].push(a.trim())}}validate(t,e){let r,s,i,n;return s=null,r=t,i=this.arrayPattern.test(t),i&&(n=this.arrayPattern.exec(t),[r,s]=n.slice(1)),r in this.supportedCards&&(e=this.verifyCard[r](e,i,s)),e}validate_(t,e){let r,s,i,n;return s=null,r=t,i=this.arrayPattern.test(t),i&&(n=this.arrayPattern.exec(t),[r,s]=n.slice(1)),r in this.verifyCard&&(e=this.verifyCard[r](e,i,s)),e}readBlock(t){let e,r,s,i,n,a,h;for(i=80,n=t.length/80,n=n<this.maxLines?n:this.maxLines,h=[],e=r=0,a=n-1;0<=a?r<=a:r>=a;e=0<=a?++r:--r)s=t.slice(80*e,80*(e+1)),h.push(this.readLine(s)),console.log("block data");return h}hasDataUnit(){return 0!==this.get("NAXIS")}getDataLength(){let t,e,r,s,i;if(!this.hasDataUnit())return 0;for(s=[],t=e=1,i=this.get("NAXIS");1<=i?e<=i:e>=i;t=1<=i?++e:--e)s.push(this.get(`NAXIS${t}`));return r=s.reduce((function(t,e){return t*e}))*Math.abs(this.get("BITPIX"))/8,r+=this.get("PCOUNT"),r}getDataType(){switch(console.log("Data type setup"),console.log(this.extensionType),this.extensionType||(this.extensionType=null),this.cards.XTENSION&&(console.log(this.cards.XTENSION.value),this.extensionType=this.cards.XTENSION.value),this.extensionType){case"BINTABLE":return console.log("BINTABLE"),this.contains("ZIMAGE")?"CompressedImage":"BinaryTable";case"TABLE":return"Table";default:return this.hasDataUnit()?"Image":null}}isPrimary(){return this.primary}isExtension(){return this.extension}}class o{constructor(t,e){this.header=t,this.data=e}hasData(){return null!=this.data}}class l extends i{dataAccessors={A:function(t){return t.trim()},I:function(t){return parseInt(t)},F:function(t){return parseFloat(t)},E:function(t){return parseFloat(t)},D:function(t){return parseFloat(t)}};setAccessors(t){let e,r,s,i,n,a,h,o,l;for(a=/([AIFED])(\d+)\.*(\d+)*/,o=[],s=i=1,h=this.cols;1<=h?i<=h:i>=h;s=1<=h?++i:--i)r=t.get(`TFORM${s}`),l=t.get(`TTYPE${s}`),n=a.exec(r),e=n[1],o.push((t=>{let e;return e=e=>this.dataAccessors[t](e),this.accessors.push(e)})(e));return o}_getRows(t){let e,r,s,i,n,a,h,o,l,u,f,c,d,g,y,p,I,B,w;for(c=t.byteLength/this.rowByteSize,r=new Uint8Array(t),I=[],n=h=0,g=c-1;0<=g?h<=g:h>=g;n=0<=g?++h:--h){for(s=n*this.rowByteSize,i=s+this.rowByteSize,B=r.subarray(s,i),u="",f=0,o=B.length;f<o;f++)w=B[f],u+=String.fromCharCode(w);for(u=u.trim().split(/\s+/),p={},y=this.accessors,a=d=0,l=y.length;d<l;a=++d)e=y[a],w=u[a],p[this.columns[a]]=e(w);I.push(p)}return I}}class u{LINEWIDTH=80;BLOCKLENGTH=2880;hdus=[];constructor(t,e){this.arrayBuffer=t,this.fitsFile=e,this.file=null,this.length=null,this.blockCount=0,this.begin=0,this.end=this.BLOCKLENGTH,this.offset=0,this.headerStorage=new Uint8Array}parseFileFromBuffer(){let t;this.file=this.arrayBuffer,this.length=this.file.byteLength,t=this.file.slice(this.begin+this.offset,this.end+this.offset);let e=this.readBlock(t);if(console.log("aaaaa"),e)return this.fitsFile;throw new Error("Error parsing the file")}async getFileAsync(){try{const t=await fetch(this.file_path),e=await t.arrayBuffer();await this.getFile(e)}catch(t){console.error(t)}}getFile(){return fetch(this.file_path).then((t=>{if(!t.ok)throw new Error(`HTTP error, status = ${t.status}`);return t.arrayBuffer()})).then((t=>this.parseFile(t)))}parseFile(t){this.file=t,console.log(this.file),this.length=this.file.byteLength,this.readFromBuffer()}readFromBuffer(){let t;return t=this.file.slice(this.begin+this.offset,this.end+this.offset),this.readBlock(t)}readFromFile(){let t;return this.reader=new FileReader,this.reader.onloadend=t=>this.readBlock(t.target.result),t=this.file.slice(this.begin+this.offset,this.end+this.offset),this.reader.readAsArrayBuffer(t)}readBlock(t){let e,r,s,i,n,l,u,f,c,d,g,y,p;for(e=new Uint8Array(t),y=new Uint8Array(this.headerStorage),this.headerStorage=new Uint8Array(this.end),this.headerStorage.set(y,0),this.headerStorage.set(e,this.begin),c=this.BLOCKLENGTH/this.LINEWIDTH;c--;)if(f=c*this.LINEWIDTH,32!==e[f]){if(69===e[f]&&78===e[f+1]&&68===e[f+2]&&32===e[f+3]){for(d="",u=this.headerStorage,n=0,l=u.length;n<l;n++)p=u[n],d+=String.fromCharCode(p);return i=new h(d,new a),this.start=this.end+this.offset,r=i.getDataLength(),g=this.file.slice(this.start,this.start+r),i.hasDataUnit()&&(s=this.createDataUnit(i,g)),this.hdus.push(new o(i,s)),this.fitsFile.addHDU(new o(i,s)),this.offset+=this.end+r+this.excessBytes(r),this.offset===this.length?(console.log("parsing complete parser"),this.headerStorage=null,!!this.fitsFile.isValid()&&(console.log("fits file"),!0)):(this.blockCount=0,this.begin=this.blockCount*this.BLOCKLENGTH,this.end=this.begin+this.BLOCKLENGTH,this.headerStorage=new Uint8Array,t=this.file.slice(this.begin+this.offset,this.end+this.offset),console.log("block"),this.readBlock(t))}break}return this.blockCount+=1,this.begin=this.blockCount*this.BLOCKLENGTH,this.end=this.begin+this.BLOCKLENGTH,t=this.file.slice(this.begin+this.offset,this.end+this.offset),this.readBlock(t)}_readBlockFromBuffer(t){return this.readBlock(t)}_readBlockFromFile(t){return this.reader.readAsArrayBuffer(t)}createDataUnit(t,e){let r,s=null;switch(console.log("Creating data unit"),r=t.getDataType(),console.log(r),r){case"BinaryTable":s=new n(t,e);break;case"Table":s=new l(t,e);break;default:s=new Image(t,e)}return s}excessBytes(t){return(this.BLOCKLENGTH-t%this.BLOCKLENGTH)%this.BLOCKLENGTH}isEOF(){return this.offset===this.length}}class f{hdus=[];constructor(){}addHDU(t){this.hdus.push(t)}isValid(){return!0}getHDU(t){let e,r,s,i;if(null!=t&&null!=this.hdus[t])return this.hdus[t];for(i=this.hdus,r=0,s=i.length;r<s;r++)if(e=i[r],e.hasData())return e}getHeader(t){return this.getHDU(t).header}getDataUnit(t){return this.getHDU(t).data}}class c{file_path=null;array_buffer=null;parser=null;constructor(t,e){this.file_path=t,this.array_buffer=e,this.parser=new u(e,new f)}parseFile(){return this.parser.parseFileFromBuffer(this.array_buffer)}}t="spi_acs_FULL_SKY_lc.fits",fetch(t).then((t=>{if(!t.ok)throw new Error(`HTTP error, status = ${t.status}`);return t.arrayBuffer()})).then((e=>function(t,e){let r=new c(e,t);console.log("start parsing main");let s=r.parseFile();console.log("parsing complete main"),console.log(s)}(e,t)));const d={print_logs:function(){console.log("aaaaa")}};return r})()));